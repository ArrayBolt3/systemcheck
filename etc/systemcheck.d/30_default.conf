## Copyright (C) 2012 - 2025 ENCRYPTED SUPPORT LLC <adrelanos@whonix.org>
## See the file COPYING for copying conditions.

## Please use "/etc/systemcheck.d/50_user.conf" for your
## custom configuration, which will override the defaults found here.
## When systemcheck is updated, this file may be overwritten.

## Run Tor leak tests by default.
#leak_tests=true

## Show (true) or hide (false) IP address during Tor leak tests.
#show_ip=true

## Stop (0) or continue (1) when an unsupported virtualizer is detected.
## 0: stop on unsupported virtualizer
## 1: do not stop on unsupported virtualizer
NO_EXIT_ON_UNSUPPORTED_VIRTUALIZER="0"

## Stop (0) or continue (1) when IP Forwarding is detected on Whonix-Gateway.
## 0: stop when IP Forwarding is detected on Whonix-Gateway
## 1: do not stop when IP Forwarding is detected on Whonix-Gateway
NO_EXIT_ON_IP_FORWARDING_DETECTION="0"

## Delete temporary files by systemcheck on exit.
## true: enabled
## false: disabled
#DEL_TMP="true"

## How long systemcheck should wait at maximum until Tor bootstrap finished.
## Defaults to: 120
#systemcheck_tor_bootstrap_wait_max="120"

## Unwanted packages systemcheck will warn against.
systemcheck_unwanted_package+=" popularity-contest " ## privacy issues
systemcheck_unwanted_package+=" canonical-census " ## privacy issues
systemcheck_unwanted_package+=" unity-lens-shopping " ## privacy issues
systemcheck_unwanted_package+=" unity-scope-video-remote " ## privacy issues
systemcheck_unwanted_package+=" unity-scope-musicstores " ## privacy issues
systemcheck_unwanted_package+=" bts " ## privacy issues
systemcheck_unwanted_package+=" wnpp-check " ## privacy issues

## https://forums.whonix.org/t/more-unwanted-packages/2155/20
## https://github.com/marmarek/openqa-tests-qubesos/blob/master/extra-files/system-tests/whonix-test.conf
systemcheck_unwanted_package+=" python-pip " ## security issues
systemcheck_unwanted_package+=" python3-pip " ## security issues

systemcheck_unwanted_package+=" gnome-calculator " ## privacy issues

## privacy concerns associated with GeoClue
## https://gitlab.freedesktop.org/geoclue/geoclue/-/issues/177
## https://github.com/Kicksecure/developer-meta-files/issues/3
## https://github.com/Whonix/anon-meta-packages/commit/d9c96fcda6e8dd8ed147d57c71843e003d898d47
systemcheck_unwanted_package+=" geoclue-2.0 "

systemcheck_unwanted_package+=" chrony " ## interferes with network time synchronization
systemcheck_unwanted_package+=" ntp " ## interferes with network time synchronization
systemcheck_unwanted_package+=" ntpdate " ## interferes with network time synchronization
systemcheck_unwanted_package+=" unattended-upgrades " ## auto-updating when apt has bugs is a security risk
## hardening, opens local listener, can be accidentally installed as dependency
## https://forums.whonix.org/t/kdeconnectd-removal
systemcheck_unwanted_package+=" kdeconnect "

## KDE was deprecated.
## https://forums.whonix.org/t/user-poll-xfce-vs-kde-kde-deprecation-considered/6235
systemcheck_unwanted_package+=" non-qubes-whonix-gateway-kde "
systemcheck_unwanted_package+=" non-qubes-whonix-workstation-kde "
systemcheck_unwanted_package+=" non-qubes-whonix-gateway "
systemcheck_unwanted_package+=" non-qubes-whonix-workstation "

## To remove selected packages from the list of unwanted packages,
## you could add something like  the following to your
## "/etc/systemcheck.d/50_user.conf". (Replace the below example that is
## using 'popularity-contest' with the actual name of the package you want
## to remove from the list.
#systemcheck_unwanted_package="$(echo "$systemcheck_unwanted_package" | sed 's/ popularity-contest //g')"

## packages ignored by the check non_freedom packages test.

systemcheck_expected_non_freedom_package+=" virtualbox " ## not useful to warn against because of below
systemcheck_expected_non_freedom_package+=" virtualbox-7.0 " ## not useful to warn against because of below
systemcheck_expected_non_freedom_package+=" virtualbox-dkms " ## not useful to warn against because of below
systemcheck_expected_non_freedom_package+=" virtualbox-guest-dkms " ## installed by default in VirtualBox
systemcheck_expected_non_freedom_package+=" virtualbox-guest-utils " ## installed by default in VirtualBox
systemcheck_expected_non_freedom_package+=" virtualbox-guest-x11 " ## installed by default in VirtualBox
systemcheck_expected_non_freedom_package+=" virtualbox-guest-additions-iso " ## installed by default in VirtualBox
systemcheck_expected_non_freedom_package+=" virtualbox-qt " ## not useful to warn against because of above

systemcheck_expected_non_freedom_package+=" b43-fwcutter "

## installed by default
## warns because it depends on another contrib package torbrowser-launcher
systemcheck_expected_non_freedom_package+=" onionshare "

## installed by default
## since onionshare depends on it
systemcheck_expected_non_freedom_package+=" torbrowser-launcher "

systemcheck_expected_non_freedom_grep_package+=" firmware "
systemcheck_expected_non_freedom_grep_package+=" microcode "

## Using the systemcheck_skip_functions variable you can blacklist one or more
## functions of systemcheck. Not all combinations of selective function
## blacklisting are tested. Blacklisting the check_tor_bootstrap function
## however is fully tested. Some combinations such as disabling
## check_tor_socks_port and leaving check_tor_trans_port enabled may result in
## systemcheck errors. Do not worry, such error do not result in danger, they
## only result in systemcheck showing an error message.

## Check first run initializer.
#systemcheck_skip_functions+=" check_initializer "

## Check Tor's bootstrap status.
## control port Uses the network. only
#systemcheck_skip_functions+=" check_tor_bootstrap "

## You most likely do not need this. Look at
## NO_EXIT_ON_UNSUPPORTED_VIRTUALIZER above.
## Does not use the network.
#systemcheck_skip_functions+=" check_virtualizer "

## You most likely do not need this. Look at
## NO_EXIT_ON_IP_FORWARDING_DETECTION above.
## Does not use the network.
#systemcheck_skip_functions+=" check_ip_forwarding_disabled "

## You most likely do not need this.
## Does not use the network. (Runs only on Whonix-Gateway.)
#systemcheck_skip_functions+=" check_tor_enabled "

## You most likely do not need this.
## Does not use the network. (Runs only on Whonix-Gateway.)
#systemcheck_skip_functions+=" check_tor_config "

## You most likely do not need this.
## Does not use the network. (Runs only on Whonix-Gateway.)
#systemcheck_skip_functions+=" check_tor_running "

## Does not use the network.
#systemcheck_skip_functions+=" check_apt_repository "

## Does not use the network.
#systemcheck_skip_functions+=" check_hostname "

## Uses the network.
#systemcheck_skip_functions+=" check_tor_socks_port "

## Uses the network.
#systemcheck_skip_functions+=" check_tor_trans_port "

## Does not use the network.
#systemcheck_skip_functions+=" check_stream_isolation "

## Checks for operating system updates using apt-get.
## Uses the network.
#systemcheck_skip_functions+=" check_operating_system "

## Uses the network.
#systemcheck_skip_functions+=" download_important_blog "

## Uses the network.
#systemcheck_skip_functions+=" download_feature_blog "

## Does not use the network.
## Textual function only.
#systemcheck_skip_functions+=" disclaimer "

## Does not use the network.
## Textual function only.
## Running with --verbose only.
#systemcheck_skip_functions+=" check_logs "

## Does not use the network.
## Textual function only.
#systemcheck_skip_functions+=" donate "

## Does not use the network.
## Configuration function only.
#systemcheck_skip_functions+=" pin_tpo_ssl_cert "

## Does not use the network.
#systemcheck_skip_functions+=" check_packages "
#systemcheck_skip_functions+=" check_meta_packages "
#systemcheck_skip_functions+=" check_unwanted_packages "

journal_ignore_pattern_add "obsolete config item"
journal_ignore_pattern_add "Tor bootstrap not done"
journal_ignore_pattern_add "FocusIn: Window .* data not initialized"
journal_ignore_pattern_add "DEBCONF_NOWARNINGS"
journal_ignore_pattern_add "Fast TSC calibration failed"
journal_ignore_pattern_add "swapon failed: Device or resource busy"
journal_ignore_pattern_add "ACPI: _OSC evaluation for CPUs failed"
journal_ignore_pattern_add "Failed to retrieve the maximum number of cpus"
journal_ignore_pattern_add "Could not attach device: Failed to open device '/sys/devices/platform/pcspkr/input/"
journal_ignore_pattern_add "Failed to connect to bus"
journal_ignore_pattern_add "Tor Consensus Time"
journal_ignore_pattern_add "WARNING: Could not determine Tor consensus time middle range."
journal_ignore_pattern_add "failed_urls: .* allowed_failures"
journal_ignore_pattern_add "No handler or method for GPE"
journal_ignore_pattern_add "error while preloading HID BPF dispatcher"
journal_ignore_pattern_add "AT-SPI: Error retrieving accessibility bus address"
journal_ignore_pattern_add "WM_HINTS"
journal_ignore_pattern_add "WM_NORMAL_HINTS"
journal_ignore_pattern_add "Connection unexpectedly closed"
journal_ignore_pattern_add "XGetWindowAttributes"
journal_ignore_pattern_add "WARNING handle_focus: FocusOut: Window"
journal_ignore_pattern_add "Failed to get window dump for window"
journal_ignore_pattern_add "kernel:  warn_alloc"
journal_ignore_pattern_add "RAS: Correctable Errors collector initialized."
journal_ignore_pattern_add "gcc /usr/src/sdwdate/sclockadj.c -o /usr/libexec/sdwdate/sclockadj"
journal_ignore_pattern_add "kernel: xen-balloon: vmemmap alloc failure:"
journal_ignore_pattern_add "Failed to load the 'mdraid' libblockdev plugin"
journal_ignore_pattern_add "failed to load module mdraid: libbd_mdraid.so.2: cannot open shared object file: No such file or directory"
journal_ignore_pattern_add "kernel.panic_on_warn"
journal_ignore_pattern_add "Tor reports: WARN"
journal_ignore_pattern_add "read-systemctl-logs-failed-units"
journal_ignore_pattern_add "can't connect to the SCdaemon: IPC connect call failed"
journal_ignore_pattern_add "Discarding this circuit."

## https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1076861
journal_ignore_pattern_add "wireplumber.service: Bound to unit pipewire.service, but unit isn't active."
journal_ignore_pattern_add "Dependency failed for wireplumber.service - Multimedia Service Session Manager."
journal_ignore_pattern_add "wireplumber.service: Job wireplumber.service/start failed with result 'dependency'."
# false positives
journal_ignore_pattern_add "audit\\[[0-9]*\\]: CRED_.* res=success"
journal_ignore_pattern_add "AVC apparmor=\"ALLOWED\""
journal_ignore_pattern_add "INFO.*Whonix firewall timesync-fail-closed mode"
journal_ignore_pattern_add "audit: CONFIG_CHANGE op=set audit_failure=1"

## sdwdate sources can sometimes fail. This is not a system issue.
## Mar 05 12:22:50 host sdwdate[1319]: ['error', 'ok', 'ok']
journal_ignore_pattern_add "sdwdate.*\['.*error.*'\]"
## Mar 05 12:22:50 host sdwdate[1319]: * remote_status: error
journal_ignore_pattern_add "sdwdate.*remote_status: error"
## Mar 05 12:22:50 host sdwdate[1319]: * stderr: connect error:
journal_ignore_pattern_add "sdwdate.*stderr: connect error:"

## Qubes issue.
## Mar 05 12:23:42 host qubes.StartApp+xfce4-terminal-dom0[1232]: Failed to connect to session manager: Failed to connect to the session manager: SESSION_MANAGER environment variable not defined
journal_ignore_pattern_add "qubes\.StartApp\+xfce4-terminal-dom0.*Failed to connect to session manager"

## Mar 28 16:43:22 host qubes.VMShell-dom0[1302]: Failed to connect to session manager: Failed to connect to the session manager: SESSION_MANAGER environment variable not defined
journal_ignore_pattern_add "qubes\.VMShell-dom0.*SESSION_MANAGER environment variable not defined"

## https://forums.whonix.org/t/systemcheck-fails-for-unclear-reason/21424/15
## [2025-03-12 21:38:51] [    3.358990] systemd-udevd[408]: /usr/bin/disabled-intelpmt-by-security-misc: ALERT: This Intel Platform Monitoring Technology (PMT) Telemetry kernel module is disabled by package security-misc by default. See the configuration file /etc/modprobe.d/30_security-misc_disable.conf for details. | args:
journal_ignore_pattern_add "systemd-udevd.*disabled-intelpmt-by-security-misc"
## [2025-03-12 21:38:51] [    3.360172] (udev-worker)[342]: Error running install command '/usr/bin/disabled-intelpmt-by-security-misc' for module pmt_class: retcode 1
journal_ignore_pattern_add "(udev-worker).*disabled-intelpmt-by-security-misc"

## Mar 25 10:09:35 localhost kernel: pinctrl core: failed to create debugfs directory
journal_ignore_pattern_add "kernel: pinctrl core: failed to create debugfs directory"

## Mar 25 10:09:35 localhost kernel: zswap: debugfs initialization failed
## debugfs is disabled in security-misc.
journal_ignore_pattern_add "kernel: zswap: debugfs initialization failed"

## Mar 25 10:09:35 localhost kernel: tirdad: module verification failed: signature and/or required key missing - tainting kernel
## Happens if SecureBoot is enabled.
## https://www.kicksecure.com/wiki/Secure_Boot
journal_ignore_pattern_add "kernel: tirdad: module verification failed: signature and/or required key missing - tainting kernel"

## Mar 18 07:10:08 localhost wireplumber[1229]: Failed to set scheduler settings: Operation not permitted
journal_ignore_pattern_add "wireplumber.*Failed to set scheduler settings: Operation not permitted"

## Mar 18 07:10:08 localhost wireplumber[1229]: GetManagedObjects() failed: org.freedesktop.DBus.Error.NameHasNoOwner
journal_ignore_pattern_add "wireplumber.*GetManagedObjects() failed: org\.freedesktop\.DBus\.Error\.NameHasNoOwner"

## Mar 18 07:10:08 localhost sdwdate[1152]: __ ### END: ### Exiting with exit_code '1' indicating 'wait, show error icon and retry.'.
journal_ignore_pattern_add "sdwdate.* indicating 'wait, show error icon and retry"

## Mar 18 07:10:08 localhost sdwdate[1152]: 2025-03-18 11:10:08 - sdwdate - INFO - PREPARATION RESULT: onion-time-pre-script detected a known permanent (until the user fixes it) error status. Consider running systemcheck for more information.
journal_ignore_pattern_add "sdwdate.*onion-time-pre-script detected a known permanent (until the user fixes it) error status"

## Mar 18 07:10:43 localhost polkit-agent-helper-1[2345]: pam_exec(polkit-1:auth): /usr/libexec/security-misc/pam_faillock_not_if_x failed: exit code 1
## Not an error.
journal_ignore_pattern_add "polkit-agent-helper-1.*pam_exec(polkit-1:auth): /usr/libexec/security-misc/pam_faillock_not_if_x failed: exit code 1"

## Not an error.
journal_ignore_pattern_add "/usr/libexec/security-misc/pam_faillock_not_if_x failed: exit code 1"

journal_ignore_pattern_add "Software updates check failure"

## Bash command.
journal_ignore_pattern_add "set -o pipefail"

## Mar 31 06:24:25 localhost updatecheck-daemon[2636]: + grep --quiet --ignore-case -E -- '^Error:|^E:|^Err:'
journal_ignore_pattern_add "updatecheck-daemon.*grep --quiet --ignore-case -E -- '\^Error:"
